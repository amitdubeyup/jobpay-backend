generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum JobStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model User {
  id        BigInt   @id @default(autoincrement())
  
  // Credentials
  email     String   @unique @db.VarChar(255)
  phone     String?  @unique @db.VarChar(20)
  password  String   @db.Text
  
  // Personal details
  firstName String?  @map("first_name") @db.VarChar(100)
  lastName  String?  @map("last_name") @db.VarChar(100)
  dob       DateTime? @db.Date
  gender    Gender?
  photoUrl  String?  @map("photo_url") @db.Text
  
  // Identity Verification (KYC)
  identityNumber String?  @map("identity_number") @db.VarChar(100)
  identityStatus Boolean  @default(false) @map("identity_status")
  identityUrl    String?  @map("identity_url") @db.Text
  
  // System / Account
  username       String?   @unique @db.VarChar(50)
  role           UserRole  @default(USER)
  countryCode    String?   @map("country_code") @db.VarChar(5)
  isActive       Boolean   @default(false) @map("is_active")
  emailVerified  Boolean   @default(false) @map("email_verified")
  mobileVerified Boolean   @default(false) @map("mobile_verified")
  signupSource   String?   @map("signup_source") @db.VarChar(50)
  lastLogin      DateTime? @map("last_login")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  // Relations
  jobs         Job[]
  applications Application[]
  bookmarks    Bookmark[]

  @@map("users")
  // Single-column indexes
  @@index([email])
  @@index([phone])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@index([identityStatus])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([isActive, createdAt])      // Active users listing
  @@index([role, isActive])           // Role-based filtering
  @@index([emailVerified, createdAt]) // Verification flows
}

model Job {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  budget      Int
  status      JobStatus @default(OPEN)
  skills      String[]  @default([])
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete
  
  // Relations
  poster       User          @relation(fields: [posterId], references: [id], onDelete: Cascade)
  posterId     BigInt
  applications Application[]
  bookmarks    Bookmark[]

  @@map("jobs")
  // Single-column indexes
  @@index([posterId])
  @@index([status])
  @@index([createdAt])
  @@index([budget])
  // Composite indexes for common query patterns
  @@index([status, createdAt])           // Job search by status
  @@index([posterId, status])            // Employer's jobs by status
  @@index([status, isActive, createdAt]) // Active job listings
  @@index([isActive, createdAt])         // All active jobs sorted
}

model Application {
  id          Int               @id @default(autoincrement())
  coverLetter String?           @map("cover_letter") @db.Text
  resumeUrl   String?           @map("resume_url") @db.Text
  status      ApplicationStatus @default(PENDING)
  appliedAt   DateTime          @default(now()) @map("applied_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  reviewedAt  DateTime?         @map("reviewed_at")
  notes       String?           @db.Text // Employer's private notes

  // Relations
  applicant   User   @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  applicantId BigInt @map("applicant_id")
  job         Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId       Int    @map("job_id")

  @@unique([applicantId, jobId]) // One application per user per job
  @@map("applications")
  @@index([applicantId])
  @@index([jobId])
  @@index([status])
  @@index([appliedAt])
  @@index([jobId, status])           // Job applications by status
  @@index([applicantId, status])     // User applications by status
}

model Bookmark {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId BigInt @map("user_id")
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId  Int    @map("job_id")

  @@unique([userId, jobId]) // One bookmark per user per job
  @@map("bookmarks")
  @@index([userId])
  @@index([jobId])
  @@index([userId, createdAt]) // User's bookmarks sorted by date
}
